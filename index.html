import React, { useState, useEffect } from 'react';
import { AlertCircle, CheckCircle, XCircle, RotateCcw, Trophy, Clock, BookOpen, Award } from 'lucide-react';

// Dati del quiz (sample - nel progetto reale importerai tutto il JSON)
const QUIZ_DATA = [
  {
    qnum: 1,
    instruction: "Si definisce combustibile ogni sostanza che:",
    options: {
      A: "√® capace di bruciare solo in assenza di ossigeno",
      B: "√® capace di bruciare",
      C: "pu√≤ incendiarsi solo ad altissime temperature"
    },
    correct_label: "B",
    correct_text: "√® capace di bruciare"
  },
  {
    qnum: 2,
    instruction: "La combustione √®:",
    options: {
      A: "Una reazione chimica endotermica (che assorbe calore)",
      B: "Una reazione chimica esotermica (che sviluppa calore) tra un combustibile e un comburente",
      C: "Una trasformazione fisica irreversibile"
    },
    correct_label: "B",
    correct_text: "Una reazione chimica esotermica (che sviluppa calore) tra un combustibile e un comburente"
  },
  {
    qnum: 3,
    instruction: "Il triangolo del fuoco √® formato da:",
    options: {
      A: "Combustibile, Comburente e Temperatura",
      B: "Combustibile, Comburente e Innesco",
      C: "Combustibile, Comburente e Reazione a catena"
    },
    correct_label: "B",
    correct_text: "Combustibile, Comburente e Innesco"
  }
];

const MODES = {
  training: {
    name: 'Allenamento',
    questions: 'infinite',
    maxErrors: null,
    timeLimit: null,
    description: 'Impara dai test senza limiti'
  },
  exam: {
    name: 'Simulazione Esame',
    questions: 15,
    maxErrors: 5,
    timeLimit: 30 * 60, // 30 minuti
    description: '15 domande, 30 minuti, max 5 errori'
  }
};

const QuizAntincendioApp = () => {
  const [quizState, setQuizState] = useState('start');
  const [mode, setMode] = useState(null);
  const [selectedQuestions, setSelectedQuestions] = useState([]);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [incorrectCount, setIncorrectCount] = useState(0);
  const [answeredQuestions, setAnsweredQuestions] = useState([]);
  const [showFeedback, setShowFeedback] = useState(false);
  const [startTime, setStartTime] = useState(null);
  const [endTime, setEndTime] = useState(null);
  const [timeRemaining, setTimeRemaining] = useState(0);

  // Timer effect
  useEffect(() => {
    if (quizState === 'quiz' && mode === 'exam' && timeRemaining > 0) {
      const timer = setInterval(() => {
        setTimeRemaining(prev => {
          if (prev <= 1) {
            endQuiz();
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
      return () => clearInterval(timer);
    }
  }, [quizState, mode, timeRemaining]);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const getElapsedTime = () => {
    if (!startTime) return 0;
    const end = endTime || Date.now();
    return Math.floor((end - startTime) / 1000);
  };

  const selectMode = (selectedMode) => {
    setMode(selectedMode);
    startQuiz(selectedMode);
  };

  const startQuiz = (selectedMode) => {
    const shuffled = [...QUIZ_DATA].sort(() => Math.random() - 0.5);
    const questions = selectedMode === 'training' 
      ? shuffled 
      : shuffled.slice(0, MODES.exam.questions);
    
    setSelectedQuestions(questions);
    setCurrentQuestionIndex(0);
    setIncorrectCount(0);
    setAnsweredQuestions([]);
    setSelectedAnswer(null);
    setShowFeedback(false);
    setStartTime(Date.now());
    setEndTime(null);
    
    if (selectedMode === 'exam') {
      setTimeRemaining(MODES.exam.timeLimit);
    }
    
    setQuizState('quiz');
  };

  const handleAnswerSelect = (option) => {
    if (showFeedback) return;
    setSelectedAnswer(option);
  };

  const handleConfirmAnswer = () => {
    if (!selectedAnswer) return;

    const currentQuestion = selectedQuestions[currentQuestionIndex];
    const isCorrect = selectedAnswer === currentQuestion.correct_label;
    
    if (!isCorrect) {
      setIncorrectCount(prev => prev + 1);
    }

    setAnsweredQuestions(prev => [...prev, {
      question: currentQuestion,
      userAnswer: selectedAnswer,
      isCorrect
    }]);

    setShowFeedback(true);

    if (mode === 'exam' && incorrectCount + (isCorrect ? 0 : 1) > MODES.exam.maxErrors) {
      setTimeout(() => endQuiz(), 2000);
    }
  };

  const handleNextQuestion = () => {
    if (currentQuestionIndex < selectedQuestions.length - 1) {
      setCurrentQuestionIndex(prev => prev + 1);
      setSelectedAnswer(null);
      setShowFeedback(false);
    } else {
      endQuiz();
    }
  };

  const handleSkipQuestion = () => {
    if (currentQuestionIndex < selectedQuestions.length - 1) {
      setCurrentQuestionIndex(prev => prev + 1);
      setSelectedAnswer(null);
      setShowFeedback(false);
    } else {
      endQuiz();
    }
  };

  const endQuiz = () => {
    setEndTime(Date.now());
    setQuizState('results');
  };

  const resetQuiz = () => {
    setQuizState('start');
    setMode(null);
    setSelectedAnswer(null);
    setShowFeedback(false);
    setStartTime(null);
    setEndTime(null);
  };

  // Schermata selezione modalit√†
  if (quizState === 'start') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full">
          <div className="text-center mb-8">
            <div className="inline-flex items-center justify-center w-20 h-20 bg-red-100 rounded-full mb-4">
              <AlertCircle className="w-10 h-10 text-red-600" />
            </div>
            <h1 className="text-4xl font-bold text-gray-800 mb-2">Quiz Antincendio</h1>
            <p className="text-gray-600 text-lg">Livello 3 - Scegli la modalit√†</p>
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            {/* Modalit√† Allenamento */}
            <div 
              onClick={() => selectMode('training')}
              className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border-2 border-blue-200 hover:border-blue-400 transition-all cursor-pointer transform hover:scale-105"
            >
              <div className="flex items-center mb-4">
                <div className="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center mr-4">
                  <BookOpen className="w-6 h-6 text-white" />
                </div>
                <h2 className="text-2xl font-bold text-blue-800">Allenamento</h2>
              </div>
              
              <p className="text-blue-700 mb-4">Impara dai test senza limiti</p>
              
              <div className="space-y-2 mb-6">
                {['Domande illimitate', 'Senza limite di tempo', 'Nessun limite di errori', 'Feedback immediato'].map((item, i) => (
                  <div key={i} className="flex items-center text-sm text-blue-800">
                    <CheckCircle className="w-4 h-4 mr-2" />
                    {item}
                  </div>
                ))}
              </div>
              
              <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors">
                Inizia Allenamento
              </button>
            </div>

            {/* Modalit√† Esame */}
            <div 
              onClick={() => selectMode('exam')}
              className="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-6 border-2 border-red-200 hover:border-red-400 transition-all cursor-pointer transform hover:scale-105"
            >
              <div className="flex items-center mb-4">
                <div className="w-12 h-12 bg-red-600 rounded-lg flex items-center justify-center mr-4">
                  <Award className="w-6 h-6 text-white" />
                </div>
                <h2 className="text-2xl font-bold text-red-800">Simulazione Esame</h2>
              </div>
              
              <p className="text-red-700 mb-4">Prova l'esame reale</p>
              
              <div className="space-y-2 mb-6">
                {['15 domande casuali', '30 minuti di tempo', 'Massimo 5 errori', 'Condizioni reali esame'].map((item, i) => (
                  <div key={i} className="flex items-center text-sm text-red-800">
                    <CheckCircle className="w-4 h-4 mr-2" />
                    {item}
                  </div>
                ))}
              </div>
              
              <button className="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition-colors">
                Inizia Simulazione
              </button>
            </div>
          </div>

          <div className="mt-8 text-center text-sm text-gray-600">
            <p>üí° Consiglio: Inizia con l'allenamento per familiarizzare con le domande</p>
          </div>
        </div>
      </div>
    );
  }

  // Schermata quiz
  if (quizState === 'quiz') {
    const currentQuestion = selectedQuestions[currentQuestionIndex];
    const config = MODES[mode];
    const progress = mode === 'training' ? 0 : ((currentQuestionIndex + 1) / selectedQuestions.length) * 100;

    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 p-4">
        <div className="max-w-2xl mx-auto">
          {/* Header */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-4">
            <div className="flex justify-between items-center mb-4">
              <div>
                <span className="text-xs font-semibold text-gray-500 uppercase">{config.name}</span>
                <p className="text-sm font-semibold text-gray-600">
                  {mode === 'training' 
                    ? `Domanda ${currentQuestionIndex + 1}`
                    : `Domanda ${currentQuestionIndex + 1} di ${selectedQuestions.length}`
                  }
                </p>
              </div>
              <div className="text-right">
                <div className="flex items-center gap-2 text-sm font-semibold">
                  <Clock className="w-4 h-4" />
                  <span className={timeRemaining <= 300 && mode === 'exam' ? 'text-red-600' : 'text-gray-700'}>
                    {mode === 'exam' ? formatTime(timeRemaining) : formatTime(getElapsedTime())}
                  </span>
                </div>
                <p className={`text-sm font-semibold ${mode === 'exam' && incorrectCount > 3 ? 'text-red-600' : 'text-gray-700'}`}>
                  Errori: {incorrectCount}{mode === 'exam' ? `/${config.maxErrors}` : ''}
                </p>
              </div>
            </div>
            {mode === 'exam' && (
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div className="bg-red-600 h-2 rounded-full transition-all" style={{ width: `${progress}%` }} />
              </div>
            )}
          </div>

          {/* Domanda */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-4">
            <h2 className="text-xl font-bold text-gray-800 mb-6">{currentQuestion.instruction}</h2>

            <div className="space-y-3">
              {Object.entries(currentQuestion.options).map(([key, value]) => {
                const isSelected = selectedAnswer === key;
                const isCorrect = key === currentQuestion.correct_label;
                const showResult = showFeedback;

                let buttonClass = "w-full text-left p-4 rounded-lg border-2 transition-all ";
                
                if (showResult) {
                  if (isCorrect) buttonClass += "border-green-500 bg-green-50";
                  else if (isSelected && !isCorrect) buttonClass += "border-red-500 bg-red-50";
                  else buttonClass += "border-gray-200 bg-gray-50";
                } else {
                  buttonClass += isSelected ? "border-red-600 bg-red-50" : "border-gray-300 hover:border-red-400 hover:bg-red-50";
                }

                return (
                  <button
                    key={key}
                    onClick={() => handleAnswerSelect(key)}
                    disabled={showFeedback}
                    className={buttonClass}
                  >
                    <div className="flex items-start">
                      <span className="font-bold text-red-600 mr-3 min-w-[24px]">{key}:</span>
                      <span className="flex-1 text-gray-700">{value}</span>
                      {showResult && isCorrect && <CheckCircle className="w-6 h-6 text-green-600 ml-2" />}
                      {showResult && isSelected && !isCorrect && <XCircle className="w-6 h-6 text-red-600 ml-2" />}
                    </div>
                  </button>
                );
              })}
            </div>

            {showFeedback && (
              <div className={`mt-6 p-4 rounded-lg ${
                selectedAnswer === currentQuestion.correct_label
                  ? 'bg-green-50 border border-green-200'
                  : 'bg-red-50 border border-red-200'
              }`}>
                <p className={`font-semibold mb-2 ${
                  selectedAnswer === currentQuestion.correct_label ? 'text-green-800' : 'text-red-800'
                }`}>
                  {selectedAnswer === currentQuestion.correct_label ? '‚úÖ Corretto!' : '‚ùå Sbagliato'}
                </p>
                {selectedAnswer !== currentQuestion.correct_label && (
                  <p className="text-sm text-gray-700">
                    La risposta corretta era: <strong>{currentQuestion.correct_label}</strong> - {currentQuestion.correct_text}
                  </p>
                )}
              </div>
            )}
          </div>

          {/* Azioni */}
          <div className="flex gap-3">
            {!showFeedback ? (
              <>
                {mode === 'training' && (
                  <button
                    onClick={endQuiz}
                    className="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-4 rounded-lg transition-colors"
                  >
                    Termina
                  </button>
                )}
                <button
                  onClick={handleSkipQuestion}
                  className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-4 rounded-lg transition-colors"
                >
                  Salta
                </button>
                <button
                  onClick={handleConfirmAnswer}
                  disabled={!selectedAnswer}
                  className={`flex-1 font-semibold py-4 rounded-lg transition-colors ${
                    selectedAnswer ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  Conferma
                </button>
              </>
            ) : (
              <button
                onClick={handleNextQuestion}
                className="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-4 rounded-lg transition-colors"
              >
                {currentQuestionIndex < selectedQuestions.length - 1 || mode === 'training' ? 'Prossima Domanda' : 'Vedi Risultati'}
              </button>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Schermata risultati
  if (quizState === 'results') {
    const config = MODES[mode];
    const correctCount = answeredQuestions.filter(q => q.isCorrect).length;
    const totalQuestions = answeredQuestions.length;
    const percentage = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;
    const elapsedTime = getElapsedTime();
    
    let passed = false;
    if (mode === 'exam') {
      passed = incorrectCount <= config.maxErrors && elapsedTime <= config.timeLimit;
    } else {
      passed = percentage >= 70;
    }

    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div className="text-center mb-8">
            <div className={`inline-flex items-center justify-center w-24 h-24 rounded-full mb-4 ${passed ? 'bg-green-100' : 'bg-red-100'}`}>
              {passed ? <Trophy className="w-12 h-12 text-green-600" /> : <XCircle className="w-12 h-12 text-red-600" />}
            </div>
            <h2 className={`text-3xl font-bold mb-2 ${passed ? 'text-green-600' : 'text-red-600'}`}>
              {mode === 'exam' ? (passed ? 'Esame Superato!' : 'Esame Non Superato') : 'Allenamento Completato'}
            </h2>
            <p className="text-gray-600 text-lg">
              {mode === 'exam' 
                ? (passed ? 'Hai superato la simulazione! üéâ' : incorrectCount > config.maxErrors ? 'Troppi errori. Riprova!' : 'Tempo scaduto!')
                : 'Hai completato l\'allenamento!'
              }
            </p>
            <p className="text-sm text-gray-500 mt-2">Modalit√†: {config.name}</p>
          </div>

          {/* Statistiche */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div className="bg-blue-50 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-blue-600">{totalQuestions}</p>
              <p className="text-sm text-gray-600">Domande</p>
            </div>
            <div className="bg-green-50 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-green-600">{correctCount}</p>
              <p className="text-sm text-gray-600">Corrette</p>
            </div>
            <div className="bg-red-50 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-red-600">{incorrectCount}</p>
              <p className="text-sm text-gray-600">Errori</p>
            </div>
            <div className="bg-purple-50 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-purple-600">{formatTime(elapsedTime)}</p>
              <p className="text-sm text-gray-600">Tempo</p>
            </div>
          </div>

          {/* Dettaglio tempo */}
          <div className="bg-gray-50 rounded-lg p-4 mb-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-semibold text-gray-700 flex items-center">
                <Clock className="w-4 h-4 mr-2" />
                Tempo Impiegato
              </span>
              <span className="text-sm font-bold text-gray-800">{formatTime(elapsedTime)}</span>
            </div>
            {mode === 'exam' ? (
              <>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">Tempo Limite</span>
                  <span className="text-sm text-gray-700">{formatTime(config.timeLimit)}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                  <div 
                    className={`h-2 rounded-full transition-all ${elapsedTime <= config.timeLimit ? 'bg-green-600' : 'bg-red-600'}`}
                    style={{ width: `${Math.min((elapsedTime / config.timeLimit) * 100, 100)}%` }}
                  />
                </div>
              </>
            ) : (
              <p className="text-xs text-gray-500 mt-1">
                Tempo medio per domanda: {formatTime(Math.floor(elapsedTime / totalQuestions))}
              </p>
            )}
          </div>

          {/* Percentuale */}
          <div className="mb-8">
            <div className="flex justify-between mb-2">
              <span className="text-sm font-semibold text-gray-600">Percentuale Corrette</span>
              <span className="text-sm font-bold text-gray-800">{percentage}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-3">
              <div 
                className={`h-3 rounded-full transition-all ${
                  percentage >= 70 ? 'bg-green-600' : percentage >= 50 ? 'bg-yellow-600' : 'bg-red-600'
                }`}
                style={{ width: `${percentage}%` }}
              />
            </div>
            <p className="text-xs text-gray-500 mt-1 text-center">
              {percentage >= 90 ? 'Eccellente! üåü' : 
                percentage >= 70 ? 'Ottimo lavoro! üëç' : 
                percentage >= 50 ? 'Buon inizio, continua ad allenarti! üí™' : 
                'Continua a studiare! üìö'}
            </p>
          </div>

          {/* Riepilogo errori */}
          {incorrectCount > 0 ? (
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
              <h3 className="font-semibold text-red-800 mb-3 flex items-center">
                <AlertCircle className="w-5 h-5 mr-2" />
                Domande Sbagliate ({incorrectCount})
              </h3>
              <div className="space-y-3 max-h-60 overflow-y-auto">
                {answeredQuestions
                  .filter(q => !q.isCorrect)
                  .map((q, idx) => (
                    <div key={idx} className="bg-white rounded p-3 text-sm">
                      <p className="font-semibold text-gray-800 mb-1">{q.question.instruction}</p>
                      <p className="text-red-600">‚ùå Tua risposta: {q.userAnswer}</p>
                      <p className="text-green-600">‚úì Risposta corretta: {q.question.correct_label} - {q.question.correct_text}</p>
                    </div>
                  ))}
              </div>
            </div>
          ) : (
            <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6 text-center">
              <p className="text-green-800 font-semibold">üéØ Perfetto! Nessun errore!</p>
            </div>
          )}

          {/* Pulsanti */}
          <div className="flex gap-3">
            <button
              onClick={resetQuiz}
              className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-4 rounded-lg transition-colors"
            >
              Cambia Modalit√†
            </button>
            <button
              onClick={() => startQuiz(mode)}
              className="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-4 rounded-lg transition-colors flex items-center justify-center gap-2"
            >
              <RotateCcw className="w-5 h-5" />
              {mode === 'exam' ? 'Riprova Esame' : 'Continua Allenamento'}
            </button>
          </div>

          {mode === 'exam' && (
            <div className="mt-6 text-center">
              <p className="text-sm text-gray-600">
                {passed ? 'üéì Complimenti! Sei pronto per l\'esame reale!' : 'üí° Suggerimento: Prova la modalit√† Allenamento per migliorare'}
              </p>
            </div>
          )}
        </div>
      </div>
    );
  }

  return null;
};

export default QuizAntincendioApp;